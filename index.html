<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Cards | Official</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --felt: #0a5c36; --dark: #0a0a0a; --shine: rgba(255,255,255,0.2); }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* PANTALLA DE CARGA (SPLASH) */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000; transition: opacity 1s ease;
        }
        .logo-container { position: relative; margin-bottom: 20px; }
        .logo-text { font-size: 3rem; font-weight: 900; color: var(--gold); letter-spacing: 5px; text-shadow: 0 0 20px rgba(212, 175, 55, 0.5); animation: pulse 2s infinite; }
        .loader-bar { width: 200px; height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin-top: 20px; }
        .loader-progress { width: 0%; height: 100%; background: var(--gold); animation: load 3s forwards; }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        @keyframes load { to { width: 100%; } }

        /* FONDO ANIMADO */
        .bg-animation { position: fixed; width: 100%; height: 100%; z-index: -1; background: #0a0a0a; }
        .floating-card { position: absolute; opacity: 0.1; font-size: 40px; animation: float 15s linear infinite; bottom: -100px; color: var(--gold); }
        @keyframes float { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(-110vh) rotate(360deg); } }

        /* COMPONENTES GENERALES */
        .screen { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .active { display: flex; }
        .card-menu { background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px; border: 2px solid var(--gold); text-align: center; width: 85%; max-width: 350px; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .btn-main { background: linear-gradient(to bottom, var(--gold), #b8860b); color: #000; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; text-transform: uppercase; transition: 0.2s; box-shadow: 0 4px 0 #8a6508; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #8a6508; }
        input { width: 90%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--gold); background: #111; color: white; text-align: center; }

        /* MESA DE JUEGO */
        #screen-game { background: radial-gradient(circle, var(--felt) 0%, #052c1a 100%); }
        .scoreboard { position: absolute; top: 15px; width: 92%; display: flex; justify-content: space-between; background: rgba(0,0,0,0.85); padding: 12px; border-radius: 15px; border: 1px solid var(--gold); font-size: 11px; z-index: 100; }
        .hand { display: flex; gap: 10px; position: absolute; bottom: 30px; }
        .card { width: 75px; height: 110px; background: white; border-radius: 8px; color: black; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #333; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .card[data-palo="Oros"] { color: #b8860b; } .card[data-palo="Copas"] { color: #d32f2f; }
        .card[data-palo="Espadas"] { color: #1976d2; } .card[data-palo="Bastos"] { color: #388e3c; }
        .card.in-table { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn { from { transform: scale(0.5) translateY(100px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        #played-area { display: flex; gap: 20px; height: 150px; align-items: center; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="logo-container">
            <div class="logo-text">ELITE CARDS</div>
        </div>
        <div style="font-size: 12px; color: var(--gold); letter-spacing: 2px;">CARGANDO EXPERIENCIA</div>
        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
    </div>

    <div class="bg-animation" id="bg-anim"></div>

    <div id="screen-login" class="screen">
        <div class="card-menu">
            <h1 style="color:var(--gold); margin-top:0;">BIENVENIDO</h1>
            <input type="text" id="player-nick" placeholder="NOMBRE DE USUARIO">
            <input type="password" id="player-pin" placeholder="PIN (4 D√çGITOS)" maxlength="4">
            <button class="btn-main" onclick="autenticar()">INGRESAR</button>
            <button class="btn-main" style="background: #222; color: white;" onclick="verRanking()">RANKING GLOBAL</button>
        </div>
    </div>

    <div id="screen-modes" class="screen">
        <div class="card-menu">
            <h2 id="welcome-txt" style="color:var(--gold)">HOLA</h2>
            <button class="btn-main" onclick="modoBot()">VS BOT ü§ñ</button>
            <button class="btn-main" style="background:#111; color:white;" onclick="abrirLobby()">MULTIJUGADOR üë•</button>
            <button class="btn-main" style="background:#400; color:white;" onclick="location.reload()">SALIR</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="card-menu">
            <h3 style="color:var(--gold)">SALAS ACTIVAS</h3>
            <div id="rooms-list" style="min-height: 50px; margin-bottom: 10px;"></div>
            <button class="btn-main" onclick="crearSala()">+ CREAR NUEVA SALA</button>
            <button class="btn-main" style="background:#333; color:white;" onclick="irModos()">VOLVER</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="scoreboard">
            <div id="p1-info">USUARIO<br>G: 0 | P: 0</div>
            <div style="text-align:center;"><span id="match-status" style="color:var(--gold)">TU TURNO</span><br><b id="pts-match" style="font-size: 1.2rem;">0 - 0</b></div>
            <div id="p2-info" style="text-align:right;">RIVAL<br>H: 0-0</div>
        </div>
        <div id="played-area"></div>
        <div class="hand" id="my-hand"></div>
    </div>

    <script>
        // CONFIG FIREBASE
        const firebaseConfig = { 
            apiKey: "AIzaSyBKxFnl3QcmKNTm9b2vUZ7yd3mrcK4Mzm0",
            authDomain: "grandauctioneer.firebaseapp.com",
            projectId: "grandauctioneer",
            databaseURL: "https://grandauctioneer-default-rtdb.firebaseio.com/", 
            appId: "1:779568791424:web:c71c5fd48c541755ed0b65"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let user = null, esMulti = false, mesaID = null, miRol = "host";
        let miMano = [], mesaLocal = { ptsH: 0, ptsI: 0, tiradas: [], turno: "" };
        const ICONOS = { "Oros": "ü™ô", "Copas": "üèÜ", "Espadas": "‚öîÔ∏è", "Bastos": "ü™µ" };

        // Animaci√≥n de salida del Splash
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    document.getElementById('screen-login').classList.add('active');
                }, 1000);
            }, 3000);
        });

        // JERARQU√çA REAL
        function getPower(v, p) {
            if (v===1 && p==="Espadas") return 14; if (v===1 && p==="Bastos") return 13;
            if (v===7 && p==="Espadas") return 12; if (v===7 && p==="Oros") return 11;
            if (v===3) return 10; if (v===2) return 9; if (v===1) return 8;
            if (v===12) return 7; if (v===11) return 6; if (v===10) return 5;
            if (v===7) return 4; if (v===6) return 3; if (v===5) return 2; if (v===4) return 1;
            return 0;
        }

        async function autenticar() {
            const nick = document.getElementById('player-nick').value.trim().toLowerCase();
            const pin = document.getElementById('player-pin').value;
            if(nick.length < 3 || pin.length < 4) return alert("Completa los campos.");

            const snap = await db.ref('usuarios/' + nick).once('value');
            if(snap.exists()) {
                if(snap.val().pin === pin) user = snap.val();
                else return alert("PIN Incorrecto");
            } else {
                user = { nick, pin, pts: 0, wins: 0, loss: 0 };
                await db.ref('usuarios/' + nick).set(user);
            }
            irModos();
        }

        function irModos() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-modes').classList.add('active');
            document.getElementById('welcome-txt').innerText = "HOLA, " + user.nick.toUpperCase();
        }

        function modoBot() {
            esMulti = false;
            mesaLocal = { ptsH: 0, ptsI: 0, tiradas: [], turno: user.nick };
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-game').classList.add('active');
            startBotGame();
        }

        function startBotGame() {
            const mazo = generarMazo();
            miMano = [mazo[0], mazo[2], mazo[4]];
            manoBot = [mazo[1], mazo[3], mazo[5]];
            render();
        }

        function generarMazo() {
            const m = [];
            ["Oros","Copas","Espadas","Bastos"].forEach(p => [1,2,3,4,5,6,7,10,11,12].forEach(v => m.push({v,p})));
            return m.sort(() => Math.random() - 0.5);
        }

        function abrirLobby() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-lobby').classList.add('active');
            db.ref('mesas').on('value', snap => {
                const list = document.getElementById('rooms-list'); list.innerHTML = "";
                if(snap.val()) Object.keys(snap.val()).forEach(id => {
                    if(snap.val()[id].estado === "esperando") {
                        list.innerHTML += `<button class="btn-main" onclick="unirse('${id}')">SALA DE ${snap.val()[id].host.toUpperCase()}</button>`;
                    }
                });
            });
        }

        async function crearSala() {
            mesaID = "M-" + Date.now(); miRol = "host"; esMulti = true;
            await db.ref('mesas/' + mesaID).set({
                host: user.nick, invitado: "", mazo: generarMazo(), turno: user.nick,
                ptsH: 0, ptsI: 0, tiradas: [], estado: "esperando"
            });
            iniciarEscuchaMulti();
        }

        function unirse(id) {
            mesaID = id; miRol = "invitado"; esMulti = true;
            db.ref('mesas/' + id).update({ invitado: user.nick, estado: "jugando" });
            iniciarEscuchaMulti();
        }

        function iniciarEscuchaMulti() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-game').classList.add('active');
            db.ref('mesas/' + mesaID).on('value', snap => {
                const mesa = snap.val(); if(!mesa) return;
                if(miMano.length === 0) {
                    miMano = (miRol === "host") ? [mesa.mazo[0], mesa.mazo[2], mesa.mazo[4]] : [mesa.mazo[1], mesa.mazo[3], mesa.mazo[5]];
                }
                mesaLocal = { ptsH: mesa.ptsH, ptsI: mesa.ptsI, tiradas: mesa.tiradas || [], turno: mesa.turno };
                document.getElementById('p1-info').innerHTML = `${user.nick.toUpperCase()}<br>G: ${user.wins}`;
                document.getElementById('p2-info').innerHTML = `${(miRol === "host" ? mesa.invitado : mesa.host) || "..."}<br>Pts: ?`;
                document.getElementById('pts-match').innerText = `${mesa.ptsH} - ${mesa.ptsI}`;
                render();

                if(mesaLocal.tiradas.length === 2 && miRol === "host") {
                    setTimeout(() => evaluarRondaMulti(mesa), 1000);
                }
            });
        }

        function jugar(i) {
            if(mesaLocal.turno !== user.nick || mesaLocal.tiradas.length >= 2) return;
            const c = miMano.splice(i, 1)[0];
            if(esMulti) {
                const t = [...mesaLocal.tiradas, { u: user.nick, c }];
                db.ref('mesas/' + mesaID).update({ tiradas: t, turno: "..." });
                setTimeout(() => {
                    db.ref('mesas/' + mesaID).update({ turno: (miRol === "host" ? "invitado_manual" : "host_manual") }); // Simplificaci√≥n de turno
                }, 200);
            } else {
                mesaLocal.tiradas.push({ u: user.nick, c });
                mesaLocal.turno = "Bot"; render();
                setTimeout(botTurno, 1000);
            }
        }

        function botTurno() {
            const bc = { v: Math.floor(Math.random()*12), p: "Copas" };
            mesaLocal.tiradas.push({ u: "Bot", c: bc });
            render();
            setTimeout(() => {
                const win = getPower(mesaLocal.tiradas[0].c.v, mesaLocal.tiradas[0].c.p) >= getPower(mesaLocal.tiradas[1].c.v, mesaLocal.tiradas[1].c.p) ? user.nick : "Bot";
                if(win === user.nick) mesaLocal.ptsH++; else mesaLocal.ptsI++;
                mesaLocal.tiradas = []; mesaLocal.turno = win;
                if(miMano.length === 0) startBotGame();
                render();
            }, 1000);
        }

        function render() {
            document.getElementById('match-status').innerText = (mesaLocal.turno === user.nick) ? "TU TURNO" : "ESPERANDO...";
            const h = document.getElementById('my-hand'); h.innerHTML = "";
            miMano.forEach((c, i) => {
                const d = document.createElement('div'); d.className = 'card'; d.setAttribute('data-palo', c.p);
                d.innerHTML = `<span>${c.v}</span><small>${ICONOS[c.p]}</small>`;
                d.onclick = () => jugar(i); h.appendChild(d);
            });
            const a = document.getElementById('played-area'); a.innerHTML = "";
            mesaLocal.tiradas.forEach(t => {
                a.innerHTML += `<div class="card in-table" data-palo="${t.c.p}"><span>${t.c.v}</span><small>${ICONOS[t.c.p]}</small></div>`;
            });
        }

        // Decoraci√≥n fondo
        const anim = document.getElementById('bg-anim');
        for(let i=0; i<12; i++) {
            let d = document.createElement('div'); d.className='floating-card'; d.innerText='‚ô†';
            d.style.left = Math.random()*100+'vw'; d.style.animationDelay = Math.random()*15+'s';
            anim.appendChild(d);
        }
    </script>
</body>
</html>
