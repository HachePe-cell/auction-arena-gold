<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Cards | Master Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --felt: #0a5c36; --dark: #0a0a0a; --red: #c0392b; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .screen { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s ease; }
        .active { display: flex; }

        /* UI Casino */
        .card-menu { background: rgba(10,10,10,0.95); padding: 35px; border-radius: 20px; border: 2px solid var(--gold); text-align: center; width: 85%; max-width: 360px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .btn-main { background: linear-gradient(to bottom, var(--gold), #b8860b); color: #000; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 12px; text-transform: uppercase; transition: 0.2s; }
        .btn-exit { background: var(--red); color: white; margin-top: 20px; font-size: 0.8rem; }
        input { width: 90%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--gold); background: #111; color: white; text-align: center; }

        /* Juego */
        #screen-game { background: radial-gradient(circle, var(--felt) 0%, #052c1a 100%); }
        .scoreboard { position: absolute; top: 15px; width: 90%; display: flex; justify-content: space-between; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 15px; border: 1px solid var(--gold); font-size: 12px; }
        .hand { display: flex; gap: 10px; position: absolute; bottom: 30px; animation: slideUp 0.6s ease; }
        .card { width: 75px; height: 110px; background: white; border-radius: 8px; color: black; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #333; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
        
        #played-area { display: flex; gap: 20px; height: 150px; align-items: center; }
        .exit-icon { position: absolute; top: 85px; right: 20px; background: rgba(0,0,0,0.5); border: 1px solid var(--gold); color: var(--gold); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 10px; }
    </style>
</head>
<body>

    <audio id="sfx-deal" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="sfx-play" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <div id="screen-login" class="screen active">
        <div class="card-menu">
            <h1 style="color:var(--gold); letter-spacing:3px;">ELITE CARDS</h1>
            <input type="text" id="nick" placeholder="NICKNAME">
            <input type="password" id="pin" placeholder="PIN" maxlength="4">
            <button class="btn-main" onclick="initAuth()">ENTRAR AL CASINO</button>
        </div>
    </div>

    <div id="screen-menu" class="screen">
        <div class="card-menu">
            <h2 id="user-tag" style="color:var(--gold)">HOLA</h2>
            <button class="btn-main" onclick="startBot()">PRACTICAR VS BOT</button>
            <button class="btn-main" style="background:#111; color:white;" onclick="startMulti()">MULTIJUGADOR PRO</button>
            <button class="btn-main btn-exit" onclick="location.reload()">CERRAR SESIÓN</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="scoreboard">
            <div id="p1-label">--</div>
            <div style="text-align:center">MARCADOR<br><b id="score-text">0 - 0</b></div>
            <div id="p2-label" style="text-align:right">RIVAL</div>
        </div>
        
        <div class="exit-icon" onclick="exitToMenu()">SALIR DEL JUEGO</div>
        
        <div id="played-area"></div>
        <div class="hand" id="my-hand"></div>
    </div>

    <script>
        // CONFIGURACIÓN
        const firebaseConfig = { 
            apiKey: "AIzaSyBKxFnl3QcmKNTm9b2vUZ7yd3mrcK4Mzm0",
            authDomain: "grandauctioneer.firebaseapp.com",
            projectId: "grandauctioneer",
            databaseURL: "https://grandauctioneer-default-rtdb.firebaseio.com/", 
            appId: "1:779568791424:web:c71c5fd48c541755ed0b65"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let session = { nick: "", role: "", room: null };
        let game = { myHand: [], onTable: [], score: [0, 0], turn: "" };

        // EFECTOS DE SONIDO
        const playSFX = (id) => {
            const sound = document.getElementById(id);
            sound.currentTime = 0;
            sound.play().catch(()=>{});
        };

        // NAVEGACIÓN
        const showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // LÓGICA DE USUARIO
        async function initAuth() {
            const n = document.getElementById('nick').value.trim();
            const p = document.getElementById('pin').value;
            if(!n || p.length < 4) return alert("Datos inválidos");

            session.nick = n.toLowerCase();
            document.getElementById('user-tag').innerText = "HOLA, " + n.toUpperCase();
            showScreen('screen-menu');
        }

        // MODO BOT
        function startBot() {
            session.role = "bot";
            game = { myHand: [], onTable: [], score: [0,0], turn: session.nick };
            resetMatch();
            showScreen('screen-game');
            document.getElementById('p1-label').innerText = session.nick;
            document.getElementById('p2-label').innerText = "BOT CPU";
        }

        // MATCHMAKING MULTIJUGADOR
        async function startMulti() {
            showScreen('screen-game');
            document.getElementById('p1-label').innerText = session.nick;
            document.getElementById('p2-label').innerText = "BUSCANDO...";

            const roomsRef = db.ref('matchmaking');
            const snap = await roomsRef.once('value');
            let found = false;

            if(snap.exists()) {
                snap.forEach(room => {
                    if(room.val().status === "open" && !found) {
                        session.room = room.key;
                        session.role = "guest";
                        found = true;
                    }
                });
            }

            if(found) {
                await db.ref(`matchmaking/${session.room}`).update({
                    guest: session.nick,
                    status: "full"
                });
            } else {
                session.room = "R-" + Date.now();
                session.role = "host";
                await db.ref(`matchmaking/${session.room}`).set({
                    host: session.nick,
                    guest: "",
                    status: "open",
                    onTable: [],
                    score: [0,0],
                    turn: session.nick
                });
            }
            listenRoom();
        }

        function listenRoom() {
            db.ref(`matchmaking/${session.room}`).on('value', snap => {
                const d = snap.val();
                if(!d) return;
                
                document.getElementById('p2-label').innerText = (session.role === "host" ? d.guest : d.host) || "ESPERANDO...";
                game.onTable = d.onTable || [];
                game.score = d.score;
                game.turn = d.turn;
                
                if(game.myHand.length === 0 && d.status === "full") resetMatch();
                render();

                // Host procesa la ronda
                if(game.onTable.length === 2 && session.role === "host") {
                    setTimeout(processRoundMulti, 1500);
                }
            });
        }

        // MOTOR DE CARTAS
        function resetMatch() {
            const suits = ["Oros", "Copas", "Espadas", "Bastos"];
            const vals = [1, 2, 3, 4, 7, 10, 11, 12];
            let deck = [];
            suits.forEach(s => vals.forEach(v => deck.push({v, s})));
            deck.sort(() => Math.random() - 0.5);
            
            game.myHand = [deck[0], deck[1], deck[2]];
            playSFX('sfx-deal');
            render();
        }

        function playCard(idx) {
            if(game.turn !== session.nick || game.onTable.length >= 2) return;
            
            const card = game.myHand.splice(idx, 1)[0];
            playSFX('sfx-play');

            if(session.role === "bot") {
                game.onTable.push({ u: session.nick, c: card });
                game.turn = "bot";
                render();
                setTimeout(botResponse, 1000);
            } else {
                const newTable = [...game.onTable, { u: session.nick, c: card }];
                db.ref(`matchmaking/${session.room}`).update({
                    onTable: newTable,
                    turn: "waiting" // Bloqueo para sincronizar
                }).then(() => {
                    const next = (session.role === "host") ? "guest" : "host";
                    // En un sistema real aquí se enviaría el turno al rival
                });
            }
        }

        function botResponse() {
            game.onTable.push({ u: "bot", c: {v: 1, s: "Espadas"} });
            playSFX('sfx-play');
            render();
            setTimeout(processRoundBot, 1000);
        }

        function processRoundBot() {
            // Lógica de poder simplificada
            const win = (game.onTable[0].c.v >= game.onTable[1].c.v) ? 0 : 1;
            game.score[win]++;
            game.onTable = [];
            game.turn = win === 0 ? session.nick : "bot";
            if(game.myHand.length === 0) resetMatch();
            render();
        }

        function render() {
            document.getElementById('score-text').innerText = `${game.score[0]} - ${game.score[1]}`;
            
            const handDiv = document.getElementById('my-hand');
            handDiv.innerHTML = "";
            game.myHand.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = "card";
                div.innerHTML = `${c.v}<br>${c.s[0]}`;
                div.onclick = () => playCard(i);
                handDiv.appendChild(div);
            });

            const tableDiv = document.getElementById('played-area');
            tableDiv.innerHTML = "";
            game.onTable.forEach(t => {
                const div = document.createElement('div');
                div.className = "card";
                div.innerHTML = `${t.c.v}<br>${t.c.s[0]}`;
                tableDiv.appendChild(div);
            });
        }

        function exitToMenu() {
            if(session.room) {
                db.ref(`matchmaking/${session.room}`).off(); // Detener escucha
                if(session.role === "host") db.ref(`matchmaking/${session.room}`).remove();
            }
            showScreen('screen-menu');
        }
    </script>
</body>
</html>
