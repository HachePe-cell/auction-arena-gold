<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Cards | Final Fix</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --felt: #0a5c36; --dark: #0a0a0a; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* FONDO ANIMADO MEJORADO */
        .bg-animation { position: fixed; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle, #1a1a1a, #000); }
        .floating-card { position: absolute; opacity: 0.15; font-size: 40px; animation: float 12s linear infinite; bottom: -100px; color: var(--gold); }
        @keyframes float { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(-110vh) rotate(360deg); } }

        .screen { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .active { display: flex; }

        .card-menu { background: rgba(0,0,0,0.85); padding: 30px; border-radius: 20px; border: 2px solid var(--gold); text-align: center; width: 85%; max-width: 320px; box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); }
        .btn-main { background: linear-gradient(to bottom, var(--gold), #b8860b); color: #000; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; text-transform: uppercase; }
        input { width: 90%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--gold); background: #111; color: white; text-align: center; font-size: 16px; }

        /* MESA DE JUEGO */
        #screen-game { background: radial-gradient(circle, var(--felt) 0%, #052c1a 100%); }
        .scoreboard { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--gold); font-size: 13px; z-index: 100; }
        
        .card { 
            width: 75px; height: 115px; background: white; border-radius: 10px; color: black;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; border: 3px solid #333; cursor: pointer; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.3s;
        }
        .card.in-table { animation: deal 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes deal { from { transform: translateY(100px) scale(0.5); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        .card[data-palo="Oros"] { color: #b8860b; } .card[data-palo="Copas"] { color: #d32f2f; }
        .card[data-palo="Espadas"] { color: #1976d2; } .card[data-palo="Bastos"] { color: #388e3c; }

        .hand { display: flex; gap: 12px; position: absolute; bottom: 40px; }
        #played-area { display: flex; gap: 20px; height: 160px; align-items: center; }
        
        .turn-tag { position: absolute; top: 80px; font-size: 12px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div class="bg-animation" id="bg-anim"></div>

    <div id="screen-login" class="screen active">
        <div class="card-menu">
            <h1 style="color:var(--gold); margin-bottom:20px; letter-spacing:3px;">ELITE CARDS</h1>
            <input type="text" id="player-nick" placeholder="NOMBRE DE USUARIO">
            <input type="password" id="player-pin" placeholder="PIN DE 4 D√çGITOS" maxlength="4">
            <button class="btn-main" onclick="autenticar()">ENTRAR AL JUEGO</button>
            <p style="font-size: 10px; margin-top: 15px; color: #888;">Si el usuario no existe, se crear√° autom√°ticamente.</p>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="scoreboard">
            <div>üë§ <span id="display-name">---</span> (<span id="global-pts">0</span> pts)</div>
            <div>üÜö T√ö: <span id="score-mine" style="color:var(--gold)">0</span> | BOT: <span id="score-theirs">0</span></div>
        </div>
        
        <div id="turn-indicator" class="turn-tag">TU TURNO</div>
        
        <div id="played-area"></div>
        <div class="hand" id="my-hand"></div>
    </div>

    <script>
        // CONFIG FIREBASE
        const firebaseConfig = { 
            apiKey: "AIzaSyBKxFnl3QcmKNTm9b2vUZ7yd3mrcK4Mzm0",
            authDomain: "grandauctioneer.firebaseapp.com",
            projectId: "grandauctioneer",
            databaseURL: "https://grandauctioneer-default-rtdb.firebaseio.com/", 
            appId: "1:779568791424:web:c71c5fd48c541755ed0b65"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userData = { nick: "", pin: "", pts: 0 };
        let miMano = [], manoBot = [], mesaLocal = { turno: "", ptsJ: 0, ptsB: 0, tiradas: [] };
        let bloqueado = false;
        const ICONOS = { "Oros": "ü™ô", "Copas": "üèÜ", "Espadas": "‚öîÔ∏è", "Bastos": "ü™µ" };

        // --- INICIALIZACI√ìN ---
        (function initBg() {
            const anim = document.getElementById('bg-anim');
            for(let i=0; i<12; i++) {
                let div = document.createElement('div');
                div.className = 'floating-card';
                div.innerText = ['‚ô†','‚ô£','‚ô•','‚ô¶'][Math.floor(Math.random()*4)];
                div.style.left = Math.random() * 100 + 'vw';
                div.style.animationDelay = Math.random() * 10 + 's';
                anim.appendChild(div);
            }
        })();

        // --- SISTEMA DE PODER REAL ---
        function obtenerPoder(v, p) {
            if (v === 1 && p === "Espadas") return 14;
            if (v === 1 && p === "Bastos") return 13;
            if (v === 7 && p === "Espadas") return 12;
            if (v === 7 && p === "Oros") return 11;
            if (v === 3) return 10;
            if (v === 2) return 9;
            if (v === 1) return 8; // Otros 1s
            if (v === 12) return 7; if (v === 11) return 6; if (v === 10) return 5;
            if (v === 7) return 4; // Otros 7s
            if (v === 6) return 3; if (v === 5) return 2; if (v === 4) return 1;
            return 0;
        }

        // --- AUTENTICACI√ìN ---
        async function autenticar() {
            const nick = document.getElementById('player-nick').value.trim().toLowerCase();
            const pin = document.getElementById('player-pin').value;
            if(!nick || pin.length < 4) return alert("Ingresa usuario y PIN de 4 d√≠gitos");

            const snap = await db.ref('usuarios/' + nick).once('value');
            const data = snap.val();

            if(data) {
                if(data.pin === pin) { userData = data; iniciarPartida(); }
                else alert("PIN incorrecto para este usuario");
            } else {
                userData = { nick, pin, pts: 0 };
                await db.ref('usuarios/' + nick).set(userData);
                iniciarPartida();
            }
        }

        function iniciarPartida() {
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            document.getElementById('display-name').innerText = userData.nick;
            document.getElementById('global-pts').innerText = userData.pts;
            nuevaMano();
        }

        function nuevaMano() {
            const mazo = [];
            ["Oros", "Copas", "Espadas", "Bastos"].forEach(p => [1,2,3,4,5,6,7,10,11,12].forEach(v => mazo.push({v, p})));
            mazo.sort(() => Math.random() - 0.5);
            miMano = [mazo[0], mazo[2], mazo[4]];
            manoBot = [mazo[1], mazo[3], mazo[5]];
            mesaLocal.turno = mesaLocal.turno || userData.nick;
            render();
            if(mesaLocal.turno === "Bot") setTimeout(botJuega, 1000);
        }

        // --- L√ìGICA DE TURNOS ---
        function tirarCarta(i) {
            if(mesaLocal.turno !== userData.nick || bloqueado || mesaLocal.tiradas.length >= 2) return;
            
            const carta = miMano.splice(i, 1)[0];
            mesaLocal.tiradas.push({ j: userData.nick, carta });
            mesaLocal.turno = "Bot";
            bloqueado = true;
            render();
            
            if(mesaLocal.tiradas.length === 1) setTimeout(botJuega, 1200);
            else setTimeout(evaluarRonda, 1000);
        }

        function botJuega() {
            const index = Math.floor(Math.random() * manoBot.length);
            const carta = manoBot.splice(index, 1)[0];
            mesaLocal.tiradas.push({ j: "Bot", carta });
            render();
            
            if(mesaLocal.tiradas.length === 2) setTimeout(evaluarRonda, 1000);
            else { mesaLocal.turno = userData.nick; bloqueado = false; render(); }
        }

        async function evaluarRonda() {
            const p1 = obtenerPoder(mesaLocal.tiradas[0].carta.v, mesaLocal.tiradas[0].carta.p);
            const p2 = obtenerPoder(mesaLocal.tiradas[1].carta.v, mesaLocal.tiradas[1].carta.p);
            
            const ganador = p1 >= p2 ? mesaLocal.tiradas[0].j : mesaLocal.tiradas[1].j;
            
            if(ganador === userData.nick) mesaLocal.ptsJ++; else mesaLocal.ptsB++;
            
            mesaLocal.tiradas = [];
            mesaLocal.turno = ganador;
            bloqueado = false;

            if(mesaLocal.ptsJ >= 15 || mesaLocal.ptsB >= 15) {
                const victoria = mesaLocal.ptsJ >= 15;
                alert(victoria ? "¬°GANASTE LA PARTIDA! +15 Puntos Globales" : "PERDISTE LA PARTIDA");
                if(victoria) {
                    userData.pts += 15;
                    await db.ref('usuarios/' + userData.nick).update({ pts: userData.pts });
                }
                location.reload();
            } else {
                if(miMano.length === 0) nuevaMano();
                else {
                    render();
                    if(mesaLocal.turno === "Bot") setTimeout(botJuega, 1000);
                }
            }
        }

        function render() {
            document.getElementById('score-mine').innerText = mesaLocal.ptsJ;
            document.getElementById('score-theirs').innerText = mesaLocal.ptsB;
            document.getElementById('turn-indicator').innerText = mesaLocal.turno === userData.nick ? "TU TURNO" : "ESPERANDO RIVAL...";

            const handDiv = document.getElementById('my-hand');
            handDiv.innerHTML = "";
            miMano.forEach((c, i) => {
                const d = document.createElement('div');
                d.className = 'card';
                d.setAttribute('data-palo', c.p);
                d.innerHTML = `<span>${c.v}</span><small>${ICONOS[c.p]}</small>`;
                d.onclick = () => tirarCarta(i);
                handDiv.appendChild(d);
            });

            const tableDiv = document.getElementById('played-area');
            tableDiv.innerHTML = "";
            mesaLocal.tiradas.forEach(t => {
                const d = document.createElement('div');
                d.className = 'card in-table';
                d.setAttribute('data-palo', t.carta.p);
                d.innerHTML = `<span>${t.carta.v}</span><small>${ICONOS[t.carta.p]}</small>`;
                tableDiv.appendChild(d);
            });
        }
    </script>
</body>
</html>
