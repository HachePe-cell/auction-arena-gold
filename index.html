<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Cards | Ultimate Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --felt: #0a5c36; --dark: #0a0a0a; --white: #f0f0f0; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* Animaci√≥n de Fondo */
        .bg-animation { position: fixed; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle, #1a1a1a, #000); }
        .floating-card { position: absolute; opacity: 0.1; font-size: 40px; animation: float 15s linear infinite; bottom: -100px; color: var(--gold); }
        @keyframes float { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(-110vh) rotate(360deg); } }

        .screen { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .active { display: flex; }

        /* Componentes de Interfaz */
        .card-menu { background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px; border: 2px solid var(--gold); text-align: center; width: 85%; max-width: 350px; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        .btn-main { background: linear-gradient(to bottom, var(--gold), #b8860b); color: #000; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; text-transform: uppercase; transition: 0.3s; }
        .btn-main:hover { transform: scale(1.02); filter: brightness(1.2); }
        .btn-secondary { background: #333; color: white; border: 1px solid var(--gold); }
        
        input { width: 90%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--gold); background: #111; color: white; text-align: center; }

        /* Ranking Modal */
        #modal-ranking { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 350px; background: #1a1a1a; border: 2px solid var(--gold); border-radius: 15px; padding: 20px; z-index: 1000; display: none; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; }

        /* Tablero de Juego */
        #screen-game { background: radial-gradient(circle, var(--felt) 0%, #052c1a 100%); }
        .scoreboard { position: absolute; top: 15px; width: 92%; display: flex; justify-content: space-between; background: rgba(0,0,0,0.85); padding: 12px; border-radius: 15px; border: 1px solid var(--gold); font-size: 12px; z-index: 100; }
        
        .hand { display: flex; gap: 10px; position: absolute; bottom: 30px; }
        .card { 
            width: 75px; height: 110px; background: white; border-radius: 8px; color: black;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; border: 3px solid #333; cursor: pointer; transition: 0.3s;
        }
        .card.in-table { animation: deal 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes deal { from { transform: translateY(150px) rotate(20deg); opacity: 0; } to { transform: translateY(0) rotate(0deg); opacity: 1; } }

        .card[data-palo="Oros"] { color: #b8860b; } .card[data-palo="Copas"] { color: #d32f2f; }
        .card[data-palo="Espadas"] { color: #1976d2; } .card[data-palo="Bastos"] { color: #388e3c; }

        #played-area { display: flex; gap: 20px; height: 150px; align-items: center; }
        .msg-turn { position: absolute; top: 90px; color: var(--gold); font-weight: bold; letter-spacing: 2px; text-shadow: 0 0 5px black; }
    </style>
</head>
<body>

    <div class="bg-animation" id="bg-anim"></div>

    <div id="screen-login" class="screen active">
        <div class="card-menu">
            <h1 style="color:var(--gold); margin:0 0 15px 0; letter-spacing:4px;">ELITE CARDS</h1>
            <input type="text" id="player-nick" placeholder="NOMBRE DE USUARIO">
            <input type="password" id="player-pin" placeholder="PIN (4 D√çGITOS)" maxlength="4">
            <button class="btn-main" onclick="autenticar()">INGRESAR</button>
            <button class="btn-main btn-secondary" onclick="mostrarRanking()">RANKING GLOBAL</button>
        </div>
    </div>

    <div id="screen-modes" class="screen">
        <div class="card-menu">
            <h2 style="color:var(--gold)" id="welcome-msg">BIENVENIDO</h2>
            <button class="btn-main" onclick="iniciarModoBot()">VS BOT ü§ñ</button>
            <button class="btn-main" style="background:#111; color:white;" onclick="abrirLobby()">MULTIJUGADOR üë•</button>
            <button class="btn-main btn-secondary" onclick="location.reload()">CERRAR SESI√ìN</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="card-menu">
            <h3 style="color:var(--gold)">SALAS DISPONIBLES</h3>
            <div id="rooms-container" style="max-height: 200px; overflow-y: auto; margin-bottom:15px;"></div>
            <button class="btn-main" onclick="crearMesaMulti()">+ CREAR NUEVA MESA</button>
            <button class="btn-main btn-secondary" onclick="irAMenuModos()">VOLVER</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="scoreboard">
            <div>üë§ <span id="u-name">---</span><br>G: <span id="u-w">0</span> | P: <span id="u-l">0</span></div>
            <div style="text-align:center">ESTADO<br><span id="game-status" style="color:var(--gold)">ESPERANDO</span></div>
            <div style="text-align:right">RIVAL: <span id="r-name">---</span><br><span id="vs-history">H: 0-0</span></div>
        </div>
        <div class="msg-turn" id="turn-indicator">CARGANDO...</div>
        <div id="played-area"></div>
        <div class="hand" id="my-hand"></div>
    </div>

    <div id="modal-ranking">
        <h3 style="color:var(--gold); text-align:center;">TOP 10 ELITE</h3>
        <div id="ranking-list"></div>
        <button class="btn-main" onclick="cerrarRanking()">CERRAR</button>
    </div>

    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = { 
            apiKey: "AIzaSyBKxFnl3QcmKNTm9b2vUZ7yd3mrcK4Mzm0",
            authDomain: "grandauctioneer.firebaseapp.com",
            projectId: "grandauctioneer",
            databaseURL: "https://grandauctioneer-default-rtdb.firebaseio.com/", 
            appId: "1:779568791424:web:c71c5fd48c541755ed0b65"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userData = null;
        let esMulti = false;
        let miMano = [], manoBot = [], mesaID = null, miRol = "host";
        let localMesa = { ptsJ: 0, ptsB: 0, tiradas: [], turno: "" };
        const ICONOS = { "Oros": "ü™ô", "Copas": "üèÜ", "Espadas": "‚öîÔ∏è", "Bastos": "ü™µ" };

        // 1. JERARQU√çA DE PODER REAL
        function obtenerPoder(v, p) {
            if (v === 1 && p === "Espadas") return 14;
            if (v === 1 && p === "Bastos") return 13;
            if (v === 7 && p === "Espadas") return 12;
            if (v === 7 && p === "Oros") return 11;
            if (v === 3) return 10; if (v === 2) return 9; if (v === 1) return 8;
            if (v === 12) return 7; if (v === 11) return 6; if (v === 10) return 5;
            if (v === 7) return 4; if (v === 6) return 3; if (v === 5) return 2; if (v === 4) return 1;
            return 0;
        }

        // 2. SISTEMA DE USUARIO Y LOGIN
        async function autenticar() {
            const nick = document.getElementById('player-nick').value.trim().toLowerCase();
            const pin = document.getElementById('player-pin').value;
            if(nick.length < 3 || pin.length < 4) return alert("Datos inv√°lidos");

            const snap = await db.ref('usuarios/' + nick).once('value');
            if(snap.exists()) {
                if(snap.val().pin === pin) { userData = snap.val(); }
                else return alert("PIN Incorrecto");
            } else {
                userData = { nick, pin, pts: 0, wins: 0, loss: 0 };
                await db.ref('usuarios/' + nick).set(userData);
            }
            irAMenuModos();
        }

        function irAMenuModos() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-modes').classList.add('active');
            document.getElementById('welcome-msg').innerText = "HOLA, " + userData.nick.toUpperCase();
        }

        // 3. L√ìGICA DE BOT (LOCAL)
        function iniciarModoBot() {
            esMulti = false;
            localMesa = { ptsJ: 0, ptsB: 0, tiradas: [], turno: userData.nick };
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-game').classList.add('active');
            document.getElementById('u-name').innerText = userData.nick;
            document.getElementById('r-name').innerText = "BOT ü§ñ";
            repartirLocal();
        }

        function repartirLocal() {
            const m = generarMazo();
            miMano = [m[0], m[2], m[4]];
            manoBot = [m[1], m[3], m[5]];
            render();
        }

        function generarMazo() {
            const m = [];
            ["Oros","Copas","Espadas","Bastos"].forEach(p => [1,2,3,4,5,6,7,10,11,12].forEach(v => m.push({v,p})));
            return m.sort(() => Math.random() - 0.5);
        }

        // 4. L√ìGICA MULTIJUGADOR (FIREBASE)
        function abrirLobby() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-lobby').classList.add('active');
            db.ref('mesas').on('value', snap => {
                const container = document.getElementById('rooms-container');
                container.innerHTML = "";
                const mesas = snap.val();
                if(mesas) Object.keys(mesas).forEach(id => {
                    if(mesas[id].estado === "esperando") {
                        container.innerHTML += `<button class="btn-main" onclick="unirseAMesa('${id}')">MESA DE ${mesas[id].host.toUpperCase()}</button>`;
                    }
                });
            });
        }

        async function crearMesaMulti() {
            mesaID = "MESA_" + Date.now();
            miRol = "host";
            esMulti = true;
            const mazo = generarMazo();
            await db.ref('mesas/' + mesaID).set({
                host: userData.nick, invitado: "", mazo, turno: userData.nick,
                ptsH: 0, ptsI: 0, tiradas: [], estado: "esperando"
            });
            entrarMesa();
        }

        function unirseAMesa(id) {
            mesaID = id;
            miRol = "invitado";
            esMulti = true;
            db.ref('mesas/' + id).update({ invitado: userData.nick, estado: "jugando" });
            entrarMesa();
        }

        function entrarMesa() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-game').classList.add('active');
            
            db.ref('mesas/' + mesaID).on('value', snap => {
                const mesa = snap.val();
                if(!mesa) return;
                
                // Cargar datos en pantalla
                document.getElementById('u-name').innerText = userData.nick;
                document.getElementById('r-name').innerText = (miRol === "host" ? mesa.invitado : mesa.host) || "ESPERANDO...";
                document.getElementById('u-w').innerText = userData.wins;
                document.getElementById('u-l').innerText = userData.loss;
                
                // Repartir cartas si la mano est√° vac√≠a
                if(miMano.length === 0) {
                    miMano = (miRol === "host") ? [mesa.mazo[0], mesa.mazo[2], mesa.mazo[4]] : [mesa.mazo[1], mesa.mazo[3], mesa.mazo[5]];
                }

                localMesa = { 
                    ptsJ: (miRol === "host" ? mesa.ptsH : mesa.ptsI), 
                    ptsB: (miRol === "host" ? mesa.ptsI : mesa.ptsH), 
                    tiradas: mesa.tiradas || [], 
                    turno: mesa.turno 
                };
                
                render();

                // L√≥gica de evaluaci√≥n autom√°tica por el Host
                if(localMesa.tiradas.length === 2 && miRol === "host") {
                    setTimeout(() => evaluarMulti(mesa), 1500);
                }
            });
        }

        // 5. EVALUACI√ìN Y RESULTADOS
        function evaluarMulti(mesa) {
            const p1 = obtenerPoder(mesa.tiradas[0].carta.v, mesa.tiradas[0].carta.p);
            const p2 = obtenerPoder(mesa.tiradas[1].carta.v, mesa.tiradas[1].carta.p);
            const ganadorNick = (p1 >= p2) ? mesa.tiradas[0].jugador : mesa.tiradas[1].jugador;
            
            let newPtsH = mesa.ptsH + (ganadorNick === mesa.host ? 1 : 0);
            let newPtsI = mesa.ptsI + (ganadorNick === mesa.invitado ? 1 : 0);

            if(newPtsH >= 15 || newPtsI >= 15) {
                finalizarPartidaMulti(newPtsH >= 15 ? mesa.host : mesa.invitado);
            } else {
                db.ref('mesas/' + mesaID).update({
                    tiradas: [], turno: ganadorNick, ptsH: newPtsH, ptsI: newPtsI,
                    mazo: (miMano.length === 1) ? generarMazo() : mesa.mazo
                });
            }
        }

        async function finalizarPartidaMulti(ganador) {
            const soyGanador = (userData.nick === ganador);
            userData.pts += (soyGanador ? 15 : 0);
            if(soyGanador) userData.wins++; else userData.loss++;
            
            await db.ref('usuarios/' + userData.nick).set(userData);
            alert(soyGanador ? "¬°GANASTE LA PARTIDA!" : "HAS PERDIDO");
            db.ref('mesas/' + mesaID).remove();
            location.reload();
        }

        // 6. ACCIONES DE JUEGO
        function jugarCarta(idx) {
            if(localMesa.turno !== userData.nick || localMesa.tiradas.length >= 2) return;

            const carta = miMano.splice(idx, 1)[0];
            const tirada = { jugador: userData.nick, carta };

            if(esMulti) {
                const nuevasTiradas = [...localMesa.tiradas, tirada];
                db.ref('mesas/' + mesaID).update({ 
                    tiradas: nuevasTiradas, 
                    turno: (miRol === "host" ? (localMesa.invitado || "invitado") : localMesa.host) 
                });
            } else {
                localMesa.tiradas.push(tirada);
                localMesa.turno = "Bot";
                render();
                setTimeout(iaBot, 1000);
            }
        }

        function iaBot() {
            const m = generarMazo()[0]; // El bot elige una al azar de un mazo nuevo para simular
            localMesa.tiradas.push({ jugador: "Bot", carta: m });
            render();
            setTimeout(evaluarBot, 1000);
        }

        function evaluarBot() {
            const p1 = obtenerPoder(localMesa.tiradas[0].carta.v, localMesa.tiradas[0].carta.p);
            const p2 = obtenerPoder(localMesa.tiradas[1].carta.v, localMesa.tiradas[1].carta.p);
            const win = p1 >= p2 ? localMesa.tiradas[0].jugador : localMesa.tiradas[1].jugador;

            if(win === userData.nick) localMesa.ptsJ++; else localMesa.ptsB++;
            localMesa.tiradas = [];
            localMesa.turno = win;
            
            if(miMano.length === 0) repartirLocal();
            if(localMesa.ptsJ >= 15) { alert("¬°Ganaste!"); location.reload(); }
            render();
        }

        // 7. RENDERIZADO
        function render() {
            document.getElementById('score-mine').innerText = localMesa.ptsJ;
            document.getElementById('score-theirs').innerText = localMesa.ptsB;
            document.getElementById('turn-indicator').innerText = (localMesa.turno === userData.nick) ? "TU TURNO" : "ESPERANDO...";
            
            const handContainer = document.getElementById('my-hand');
            handContainer.innerHTML = "";
            miMano.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.setAttribute('data-palo', c.p);
                div.innerHTML = `<span>${c.v}</span><small>${ICONOS[c.p]}</small>`;
                div.onclick = () => jugarCarta(i);
                handContainer.appendChild(div);
            });

            const tableContainer = document.getElementById('played-area');
            tableContainer.innerHTML = "";
            localMesa.tiradas.forEach(t => {
                const div = document.createElement('div');
                div.className = 'card in-table';
                div.setAttribute('data-palo', t.carta.p);
                div.innerHTML = `<span>${t.carta.v}</span><small>${ICONOS[t.carta.p]}</small>`;
                tableContainer.appendChild(div);
            });
        }

        // 8. RANKING GLOBAL
        async function mostrarRanking() {
            const snap = await db.ref('usuarios').orderByChild('pts').limitToLast(10).once('value');
            const list = document.getElementById('ranking-list');
            list.innerHTML = "";
            let users = [];
            snap.forEach(child => users.push(child.val()));
            users.reverse().forEach((u, i) => {
                list.innerHTML += `<div class="rank-item"><span>#${i+1} ${u.nick}</span> <b>${u.pts} PTS</b></div>`;
            });
            document.getElementById('modal-ranking').style.display = 'block';
        }
        function cerrarRanking() { document.getElementById('modal-ranking').style.display = 'none'; }

        // Inicializar Fondo
        for(let i=0; i<15; i++) {
            let d = document.createElement('div'); d.className='floating-card';
            d.innerText = ['‚ô†','‚ô£','‚ô•','‚ô¶'][Math.floor(Math.random()*4)];
            d.style.left = Math.random()*100+'vw'; d.style.animationDelay = Math.random()*10+'s';
            document.getElementById('bg-anim').appendChild(d);
        }
    </script>
</body>
</html>
