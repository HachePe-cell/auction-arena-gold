<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Cards | Pro Ranking</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --felt: #0a5c36; --dark: #0a0a0a; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* Fondo */
        .bg-animation { position: fixed; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle, #1a1a1a, #000); }
        .floating-card { position: absolute; opacity: 0.1; font-size: 40px; animation: float 12s linear infinite; bottom: -100px; color: var(--gold); }
        @keyframes float { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(-110vh) rotate(360deg); } }

        .screen { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .active { display: flex; }

        .card-menu { background: rgba(0,0,0,0.9); padding: 25px; border-radius: 20px; border: 2px solid var(--gold); text-align: center; width: 85%; max-width: 320px; box-shadow: 0 0 30px rgba(212,175,55,0.2); }
        .btn-main { background: linear-gradient(to bottom, var(--gold), #b8860b); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 8px; text-transform: uppercase; font-size: 12px; }
        input { width: 90%; padding: 10px; margin: 5px 0; border-radius: 8px; border: 1px solid var(--gold); background: #111; color: white; text-align: center; }

        /* Ranking Modal */
        #modal-ranking { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: #1a1a1a; border: 2px solid var(--gold); border-radius: 15px; padding: 20px; z-index: 1000; display: none; max-height: 80vh; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; font-size: 14px; }

        /* Juego */
        #screen-game { background: radial-gradient(circle, var(--felt) 0%, #052c1a 100%); }
        .scoreboard { position: absolute; top: 15px; width: 90%; display: flex; justify-content: space-between; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 15px; border: 1px solid var(--gold); font-size: 11px; }
        .hand { display: flex; gap: 10px; position: absolute; bottom: 30px; }
        .card { width: 70px; height: 100px; background: white; border-radius: 8px; color: black; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #333; cursor: pointer; }
    </style>
</head>
<body>

    <div class="bg-animation" id="bg-anim"></div>

    <div id="screen-login" class="screen active">
        <div class="card-menu">
            <h1 style="color:var(--gold); margin-bottom:15px;">ELITE CARDS</h1>
            <input type="text" id="player-nick" placeholder="USUARIO">
            <input type="password" id="player-pin" placeholder="PIN (4 DÃGITOS)" maxlength="4">
            <button class="btn-main" onclick="autenticar()">INGRESAR</button>
            <button class="btn-main" style="background: #333; color: white;" onclick="mostrarRanking()">VER RANKING GLOBAL</button>
        </div>
    </div>

    <div id="modal-ranking">
        <h3 style="color:var(--gold); text-align:center;">TOP JUGADORES</h3>
        <div id="ranking-list"></div>
        <button class="btn-main" onclick="cerrarRanking()">CERRAR</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="scoreboard">
            <div>ðŸ‘¤ <span id="name-j">---</span><br>G: <span id="w-j">0</span> | P: <span id="l-j">0</span></div>
            <div style="text-align: center; color: var(--gold); font-weight: bold;">VS</div>
            <div style="text-align: right;">ðŸ‘¤ RIVAL<br><span id="vs-stats">Historial: 0-0</span></div>
        </div>
        <div id="played-area" style="display:flex; gap:15px; height:120px; align-items:center;"></div>
        <div class="hand" id="my-hand"></div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyBKxFnl3QcmKNTm9b2vUZ7yd3mrcK4Mzm0",
            authDomain: "grandauctioneer.firebaseapp.com",
            projectId: "grandauctioneer",
            databaseURL: "https://grandauctioneer-default-rtdb.firebaseio.com/", 
            appId: "1:779568791424:web:c71c5fd48c541755ed0b65"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let user = { nick: "", pin: "", pts: 0, wins: 0, loss: 0 };
        let rivalActual = "Bot";
        let mesa = { ptsJ: 0, ptsB: 0, tiradas: [], turno: "" };

        // --- AUTENTICACIÃ“N ---
        async function autenticar() {
            const nick = document.getElementById('player-nick').value.trim().toLowerCase();
            const pin = document.getElementById('player-pin').value;
            if(!nick || pin.length < 4) return alert("Datos incompletos");

            const snap = await db.ref('usuarios/' + nick).once('value');
            const data = snap.val();

            if(data) {
                if(data.pin === pin) { user = data; iniciar(); }
                else alert("PIN incorrecto");
            } else {
                user = { nick, pin, pts: 0, wins: 0, loss: 0 };
                await db.ref('usuarios/' + nick).set(user);
                iniciar();
            }
        }

        function iniciar() {
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            document.getElementById('name-j').innerText = user.nick.toUpperCase();
            document.getElementById('w-j').innerText = user.wins;
            document.getElementById('l-j').innerText = user.loss;
            cargarHistorialCaraACara();
            nuevaMano();
        }

        // --- RANKING INTERNO (CARA A CARA) ---
        async function cargarHistorialCaraACara() {
            if(rivalActual === "Bot") {
                document.getElementById('vs-stats').innerText = "Vs Bot: ClÃ¡sico";
                return;
            }
            // LÃ³gica para multijugador: busca en la tabla 'enfrentamientos/user_rival'
            const path = [user.nick, rivalActual].sort().join("_");
            const snap = await db.ref('historial/' + path).once('value');
            const data = snap.val() || { [user.nick]: 0, [rivalActual]: 0 };
            document.getElementById('vs-stats').innerText = `TÃº ${data[user.nick]} - ${data[rivalActual]} Ã‰l`;
        }

        async function registrarResultado(ganoYo) {
            // 1. Actualizar perfil propio
            if(ganoYo) user.wins++; else user.loss++;
            user.pts += (ganoYo ? 15 : 0);
            await db.ref('usuarios/' + user.nick).update(user);

            // 2. Actualizar cara a cara si es contra humano (simulado aquÃ­ para el Bot)
            if(rivalActual !== "Bot") {
                const path = [user.nick, rivalActual].sort().join("_");
                const snap = await db.ref('historial/' + path).once('value');
                const data = snap.val() || { [user.nick]: 0, [rivalActual]: 0 };
                data[ganoYo ? user.nick : rivalActual]++;
                await db.ref('historial/' + path).set(data);
            }
        }

        // --- RANKING GLOBAL ---
        async function mostrarRanking() {
            const snap = await db.ref('usuarios').orderByChild('pts').limitToLast(10).once('value');
            const list = document.getElementById('ranking-list');
            list.innerHTML = "";
            let arr = [];
            snap.forEach(u => { arr.push(u.val()); });
            arr.reverse().forEach((u, i) => {
                list.innerHTML += `<div class="rank-item"><span>#${i+1} ${u.nick}</span> <b>${u.pts} pts</b></div>`;
            });
            document.getElementById('modal-ranking').style.display = 'block';
        }

        function cerrarRanking() { document.getElementById('modal-ranking').style.display = 'none'; }

        // --- LÃ“GICA DE JUEGO (SIMPLIFICADA PARA TEST) ---
        function nuevaMano() {
            mesa = { ptsJ: 0, ptsB: 0, tiradas: [], turno: user.nick };
            repartir();
        }

        function repartir() {
            const m = [];
            ["Oros","Copas","Espadas","Bastos"].forEach(p => [1,2,3,4,7,10,11,12].forEach(v => m.push({v,p})));
            m.sort(()=>Math.random()-0.5);
            miMano = [m[0],m[1],m[2]];
            render();
        }

        function tirarCarta(i) {
            if(mesa.tiradas.length >= 2) return;
            mesa.tiradas.push({ j: user.nick, c: miMano.splice(i,1)[0] });
            render();
            setTimeout(botJuega, 800);
        }

        function botJuega() {
            mesa.tiradas.push({ j: "Bot", c: {v: Math.floor(Math.random()*12), p: "Oros"} });
            render();
            setTimeout(evaluar, 800);
        }

        async function evaluar() {
            const ganoRonda = mesa.tiradas[0].c.v >= mesa.tiradas[1].c.v;
            if(ganoRonda) mesa.ptsJ++; else mesa.ptsB++;
            mesa.tiradas = [];
            if(mesa.ptsJ >= 15 || mesa.ptsB >= 15) {
                const ganoPartida = mesa.ptsJ >= 15;
                alert(ganoPartida ? "Â¡VICTORIA!" : "DERROTA");
                await registrarResultado(ganoPartida);
                location.reload();
            } else if(miMano.length === 0) repartir();
            else render();
        }

        function render() {
            document.getElementById('score-mine').innerText = mesa.ptsJ;
            document.getElementById('score-theirs').innerText = mesa.ptsB;
            const h = document.getElementById('my-hand'); h.innerHTML = "";
            miMano.forEach((c,i) => {
                const d = document.createElement('div'); d.className='card'; d.innerHTML=`${c.v}<br>${c.p[0]}`;
                d.onclick = () => tirarCarta(i); h.appendChild(d);
            });
            const a = document.getElementById('played-area'); a.innerHTML = "";
            mesa.tiradas.forEach(t => {
                a.innerHTML += `<div class="card">${t.c.v}<br>${t.c.p[0]}</div>`;
            });
        }

        // Fondo animado
        for(let i=0; i<10; i++) {
            let d = document.createElement('div'); d.className='floating-card'; d.innerText='â™¦';
            d.style.left = Math.random()*100+'vw'; d.style.animationDelay = Math.random()*10+'s';
            document.getElementById('bg-anim').appendChild(d);
        }
    </script>
</body>
</html>
