<div id="screen-auction" class="screen">
    <div style="background: #000; width: 100%; height: 35vh; display: flex; align-items: center; justify-content: center;">
        <img id="item-img" src="" style="max-height: 100%; max-width: 100%;">
    </div>
    
    <div style="padding: 15px; flex-grow: 1; display: flex; flex-direction: column;">
        <h2 id="item-title" style="font-size: 1.2rem; margin: 5px 0;">Cargando...</h2>
        
        <div id="bid-status" style="background: #222; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 10px; font-weight: bold; border: 1px solid #444;">
            <span id="bid-leader-name" style="color: #ff4444;">ESPERANDO OFERTAS</span>
        </div>

        <div id="bid-history" style="background: rgba(255,255,255,0.05); height: 80px; overflow: hidden; font-size: 0.8rem; padding: 10px; border-left: 2px solid var(--gold); margin-bottom: 10px;">
            <div style="color: #888;">Historial de sala:</div>
            <div id="history-lines"></div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <small style="color: var(--gold);">OFERTA ACTUAL</small>
                <div style="font-size: 2rem; font-weight: bold;">$<span id="ui-bid">0</span></div>
            </div>
            <div id="ui-timer" style="font-size: 2.5rem; color: #ff4444; font-weight: bold;">10</div>
        </div>

        <button class="btn" onclick="makeBid()" style="margin-top: auto;">PUJAR +$1,000</button>
    </div>
</div>

<script>
    // ... (Mantén tu configuración de Firebase igual arriba) ...

    const RIVALES = ["Magnate Suizo", "Inversor de Arte", "Coleccionista Anónimo", "Museo de Louvre (Proxy)", "Galería de NY", "Barón von Art"];
    let state = { 
        name: "", 
        balance: 25000, 
        currentBid: 0, 
        timer: 10, 
        interval: null, 
        leader: "", 
        history: [] 
    };

    function login() {
        const input = document.getElementById('player-name').value;
        state.name = input || "Postor_" + Math.floor(Math.random()*999);
        showScreen('screen-menu');
    }

    // --- LÓGICA DE SUBASTA MEJORADA ---
    function addHistory(user, amount) {
        const line = `<div style="color: ${user === state.name ? '#44ff44' : '#fff'}">
            <strong>${user}</strong> ofreció $${amount.toLocaleString()}
        </div>`;
        state.history.unshift(line);
        if(state.history.length > 3) state.history.pop();
        document.getElementById('history-lines').innerHTML = state.history.join('');
    }

    function updateLeaderUI() {
        const statusBox = document.getElementById('bid-status');
        const leaderText = document.getElementById('bid-leader-name');
        
        if (state.leader === state.name) {
            leaderText.innerText = "¡VAS GANANDO!";
            statusBox.style.borderColor = "#44ff44";
            leaderText.style.color = "#44ff44";
        } else {
            leaderText.innerText = "LÍDER: " + state.leader.toUpperCase();
            statusBox.style.borderColor = "#ff4444";
            leaderText.style.color = "#ff4444";
        }
    }

    async function startAuction() {
        state.history = [];
        document.getElementById('history-lines').innerHTML = "";
        showScreen('screen-auction');
        
        try {
            const r = await fetch('https://collectionapi.metmuseum.org/public/collection/v1/search?hasImages=true&q=gold');
            const d = await r.json();
            const objId = d.objectIDs[Math.floor(Math.random() * 50)];
            const or = await fetch(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${objId}`);
            const od = await or.json();

            document.getElementById('item-img').src = od.primaryImageSmall;
            document.getElementById('item-title').innerText = od.title;
            
            state.currentBid = Math.floor(Math.random() * 5000) + 2000;
            state.leader = RIVALES[Math.floor(Math.random() * RIVALES.length)];
            state.timer = 12;
            
            addHistory(state.leader, state.currentBid);
            updateLeaderUI();
            runAuction();
        } catch(e) { 
            alert("Error del Museo."); 
            showScreen('screen-menu'); 
        }
    }

    function runAuction() {
        clearInterval(state.interval);
        state.interval = setInterval(() => {
            state.timer--;
            document.getElementById('ui-timer').innerText = state.timer;
            document.getElementById('ui-bid').innerText = state.currentBid.toLocaleString();
            
            // Lógica de contraoferta de la IA
            if(state.timer > 1 && Math.random() > 0.75 && state.leader === state.name) {
                state.currentBid += 1000;
                state.leader = RIVALES[Math.floor(Math.random() * RIVALES.length)];
                state.timer = 8; // La IA da pelea
                addHistory(state.leader, state.currentBid);
                updateLeaderUI();
            }

            if(state.timer <= 0) {
                clearInterval(state.interval);
                finishAuction();
            }
        }, 1000);
    }

    function makeBid() {
        if(state.balance < state.currentBid + 1000) return alert("Fondos insuficientes");
        state.currentBid += 1000;
        state.leader = state.name;
        state.timer = 7; // Reset de tiempo para dar oportunidad a otros
        addHistory(state.name, state.currentBid);
        updateLeaderUI();
    }

    async function finishAuction() {
        if(state.leader === state.name) {
            alert("¡FELICIDADES! Ganaste la subasta por $" + state.currentBid.toLocaleString());
