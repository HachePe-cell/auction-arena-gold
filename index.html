<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Cards | Battle Mode</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --felt: #0a5c36; --oro: #b8860b; --copa: #d32f2f; --espada: #1976d2; --basto: #388e3c; }
        body, html { margin: 0; padding: 0; height: 100%; background: #121212; color: white; font-family: sans-serif; overflow: hidden; }
        .screen { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }

        /* Estilo General */
        .card-menu { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px; border: 1px solid var(--gold); text-align: center; width: 80%; max-width: 350px; }
        .btn-main { background: var(--gold); color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; text-transform: uppercase; }
        input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: none; }

        /* Mesa y Marcador */
        #screen-game { background: radial-gradient(circle, var(--felt) 0%, #052c1a 100%); }
        .scoreboard { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px; border: 1px solid var(--gold); font-size: 0.8rem; }
        
        .hand { display: flex; gap: 10px; position: absolute; bottom: 30px; }
        .card { 
            width: 75px; height: 110px; background: white; border-radius: 8px; color: black;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; border: 3px solid #333; cursor: pointer; position: relative;
        }
        .card[data-palo="Oros"] { color: var(--oro); border-color: var(--oro); }
        .card[data-palo="Copas"] { color: var(--copa); border-color: var(--copa); }
        .card[data-palo="Espadas"] { color: var(--espada); border-color: var(--espada); }
        .card[data-palo="Bastos"] { color: var(--basto); border-color: var(--basto); }

        #played-area { width: 90%; height: 150px; display: flex; justify-content: center; align-items: center; gap: 15px; }
        .status-msg { position: absolute; top: 80px; background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 30px; font-size: 0.8rem; border: 1px solid var(--gold); }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="card-menu">
            <h1 style="color:var(--gold)">ELITE CARDS</h1>
            <input type="text" id="player-nick" placeholder="Tu Apodo">
            <button class="btn-main" onclick="entrar()">ENTRAR</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <h2 style="color:var(--gold)">Lobby Multijugador</h2>
        <div id="rooms-container"></div>
        <button class="btn-main" style="width:70%; margin-top:20px;" onclick="crearMesa()">CREAR MESA</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="scoreboard">
            NOSOTROS: <span id="score-mine">0</span><br>
            ELLOS: <span id="score-theirs">0</span>
        </div>
        <div id="turn-indicator" class="status-msg">Esperando...</div>
        <div id="played-area"></div>
        <div class="hand" id="my-hand"></div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyBKxFnl3QcmKNTm9b2vUZ7yd3mrcK4Mzm0",
            authDomain: "grandauctioneer.firebaseapp.com",
            projectId: "grandauctioneer",
            databaseURL: "https://grandauctioneer-default-rtdb.firebaseio.com/", 
            storageBucket: "grandauctioneer.firebasestorage.app",
            appId: "1:779568791424:web:c71c5fd48c541755ed0b65"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let miNombre = "", miMano = [], mesaID = null, miRol = "";
        const ICONOS = { "Oros": "ðŸª™", "Copas": "ðŸ†", "Espadas": "âš”ï¸", "Bastos": "ðŸªµ" };

        // JERARQUÃA DE PODER (Estilo Truco simplificado)
        function obtenerPoder(valor, palo) {
            if (valor === 1 && palo === "Espadas") return 14; // El Ancho de Espadas
            if (valor === 1 && palo === "Bastos") return 13;  // El Ancho de Bastos
            if (valor === 7 && palo === "Espadas") return 12;
            if (valor === 7 && palo === "Oros") return 11;
            if (valor === 3) return 10;
            if (valor === 2) return 9;
            if (valor === 1) return 8;
            return valor; // Los demÃ¡s valen su nÃºmero
        }

        function entrar() {
            miNombre = document.getElementById('player-nick').value.trim();
            if(miNombre) {
                document.getElementById('screen-login').style.display = 'none';
                document.getElementById('screen-lobby').style.display = 'flex';
                escucharMesas();
            }
        }

        function crearMesa() {
            const id = "Mesa-" + Math.floor(Math.random()*9000);
            const mazo = generarMazo().sort(() => Math.random() - 0.5);
            db.ref('mesas/' + id).set({
                host: miNombre, invitado: "", mazo: mazo, turno: miNombre, estado: "esperando", 
                cartasTiradas: [], puntosHost: 0, puntosInvitado: 0
            }).then(() => unirse(id));
        }

        function escucharMesas() {
            db.ref('mesas').on('value', snap => {
                const container = document.getElementById('rooms-container');
                container.innerHTML = "";
                const mesas = snap.val();
                if(mesas) {
                    Object.keys(mesas).forEach(id => {
                        if(mesas[id].estado === "esperando") {
                            container.innerHTML += `<button class="btn-main" style="margin:5px" onclick="unirse('${id}')">Unirse a ${mesas[id].host}</button>`;
                        }
                    });
                }
            });
        }

        function unirse(id) {
            mesaID = id;
            db.ref('mesas/'+id).once('value', snap => {
                const mesa = snap.val();
                miRol = (mesa.host === miNombre) ? "host" : "invitado";
                if(miRol === "invitado") db.ref('mesas/'+id).update({ invitado: miNombre, estado: "jugando" });
                document.getElementById('screen-lobby').style.display = 'none';
                document.getElementById('screen-game').style.display = 'flex';
                gestionarPartida();
            });
        }

        function gestionarPartida() {
            db.ref('mesas/' + mesaID).on('value', snap => {
                const mesa = snap.val();
                if(!mesa) return;

                if(mesa.estado === "jugando" && miMano.length === 0) {
                    miMano = (miRol === "host") ? [mesa.mazo[0], mesa.mazo[2], mesa.mazo[4]] : [mesa.mazo[1], mesa.mazo[3], mesa.mazo[5]];
                    renderHand();
                }

                // Actualizar Marcador
                document.getElementById('score-mine').innerText = (miRol === "host") ? mesa.puntosHost : mesa.puntosInvitado;
                document.getElementById('score-theirs').innerText = (miRol === "host") ? mesa.puntosInvitado : mesa.puntosHost;

                const tInd = document.getElementById('turn-indicator');
                tInd.innerText = (mesa.turno === miNombre) ? "TU TURNO" : "ESPERANDO A " + mesa.turno;

                renderTable(mesa.cartasTiradas || []);

                // LÃ“GICA DE GANADOR DE RONDA
                if(mesa.cartasTiradas && mesa.cartasTiradas.length === 2) {
                    setTimeout(() => evaluarGanadorRonda(mesa), 2000);
                }
            });
        }

        function evaluarGanadorRonda(mesa) {
            if(miRol !== "host") return; // Solo el host calcula para evitar conflictos

            const c1 = mesa.cartasTiradas[0];
            const c2 = mesa.cartasTiradas[1];
            const p1 = obtenerPoder(c1.carta.valor, c1.carta.palo);
            const p2 = obtenerPoder(c2.carta.valor, c2.carta.palo);

            let ganador = (p1 >= p2) ? c1.jugador : c2.jugador;
            let pHost = mesa.puntosHost + (ganador === mesa.host ? 1 : 0);
            let pInv = mesa.puntosInvitado + (ganador === mesa.invitado ? 1 : 0);

            db.ref('mesas/' + mesaID).update({
                cartasTiradas: [],
                turno: ganador, // El que gana la mano, empieza la siguiente
                puntosHost: pHost,
                puntosInvitado: pInv
            });
        }

        function renderHand() {
            const container = document.getElementById('my-hand');
            container.innerHTML = "";
            miMano.forEach((c, i) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                cardDiv.setAttribute('data-palo', c.palo);
                cardDiv.innerHTML = `<div>${c.valor}</div><div>${ICONOS[c.palo]}</div>`;
                cardDiv.onclick = () => tirarCarta(i);
                container.appendChild(cardDiv);
            });
        }

        function tirarCarta(index) {
            db.ref('mesas/' + mesaID).once('value', snap => {
                const mesa = snap.val();
                if(mesa.turno !== miNombre || (mesa.cartasTiradas && mesa.cartasTiradas.length >= 2)) return;

                const carta = miMano.splice(index, 1)[0];
                const tiradas = mesa.cartasTiradas || [];
                tiradas.push({ jugador: miNombre, carta: carta });

                const siguienteTurno = (miRol === "host") ? (mesa.invitado || miNombre) : mesa.host;
                db.ref('mesas/' + mesaID).update({ cartasTiradas: tiradas, turno: siguienteTurno });
                renderHand();
            });
        }

        function renderTable(tiradas) {
            const area = document.getElementById('played-area');
            area.innerHTML = "";
            tiradas.forEach(t => {
                area.innerHTML += `<div class="card" data-palo="${t.carta.palo}" style="cursor:default"><div>${t.carta.valor}</div><div>${ICONOS[t.carta.palo]}</div><small style="font-size:8px">${t.jugador}</small></div>`;
            });
        }

        function generarMazo() {
            const m = [];
            ["Oros", "Copas", "Espadas", "Bastos"].forEach(p => [1,2,3,4,5,6,7,10,11,12].forEach(v => m.push({valor:v, palo:p})));
            return m;
        }
    </script>
</body>
</html>
